<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CrocheMama Add Incoming Inventory</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#b65d00",
                        "primary-soft": "#FDECE7",
                        "accent-sage": "#8da399",
                        "accent-teal": "#4b8f8c",
                        "accent-rose": "#d6aeb4",
                        "background-light": "#f8f7f5",
                        "background-dark": "#23190f",
                        "card-light": "#ffffff",
                        "card-dark": "#2a1b1f",
                        "text-main": "#4A3B37",
                        "text-muted": "#8C807B",
                        "coral-orange": "#E05A4A",
                        "desaturated-teal": "#8da399",
                        "desaturated-orange": "#F8BD7F"
                    },
                    fontFamily: {
                        display: "Plus Jakarta Sans"
                    },
                    backgroundImage: {
                        "knit-pattern": "url(\"data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v2.5h20zm0-11V7H0v2.5h20zM20 40V37.5H0V40h20zM40 20.5V18H20v2.5h20zm0-11V7H20v2.5h20zM40 40V37.5H20V40h20z' fill='%23e8e4e0' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E\")",
                        "subtle-fabric": "url(\"data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23dcd6d1' fill-opacity='0.1'%3E%3Cpath d='M0 0h16v16H0V0zm1 1h14v14H1V1z'/%3E%3Cpath d='M2 0h1v16H2V0zm4 0h1v16H6V0zm4 0h1v16h-1V0zm4 0h1v16h-1V0zM0 2h16v1H0V2zm0 4h16v1H0V6zm0 4h16v1H0v10zm0 4h16v1H0v14z'/%3C/g%3E%3C/svg%3E\")"
                    },
                    borderRadius: {
                        DEFAULT: "0.125rem",
                        lg: "0.25rem",
                        xl: "0.5rem",
                        full: "0.75rem"
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .font-display {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .card-shadow-soft {
            box-shadow: 0 8px 30px -8px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-gray-100 min-h-screen flex flex-col font-display">
    <header
        class="sticky top-0 z-50 w-full bg-white/80 dark:bg-card-dark/90 backdrop-blur-sm border-b border-[#e8e4e0] dark:border-gray-800 px-6 py-4 transition-all duration-300">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <img src="logo/logo.webp" alt="CrocheMama Logo" class="size-10 rounded-full object-cover">
                <h1 class="text-xl md:text-2xl font-extrabold tracking-tight text-text-main dark:text-white">CrocheMama
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative hidden md:block w-72 lg:w-96 transition-all duration-300">
                    <span
                        class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-text-muted text-2xl">search</span>
                    <input aria-label="Search dashboard"
                        class="w-full pl-14 pr-24 py-3.5 rounded-full bg-white dark:bg-card-dark border border-gray-100 dark:border-gray-700 shadow-sm text-base text-text-main dark:text-white placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all hover:shadow-md"
                        placeholder="Search..." type="text" />
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1">
                        <a href="notification.html"
                            class="p-2 text-text-muted hover:text-primary transition-colors rounded-full hover:bg-gray-50 dark:hover:bg-gray-800 relative">
                            <span class="material-symbols-outlined text-xl">notifications</span>
                            <span
                                class="absolute top-2 right-2 size-2 bg-primary rounded-full ring-1 ring-white dark:ring-card-dark"></span>
                        </a>
                        <button
                            class="p-2 text-text-muted hover:text-primary transition-colors rounded-full hover:bg-gray-50 dark:hover:bg-gray-800">
                            <span class="material-symbols-outlined text-xl">person</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="flex-1 w-full bg-knit-pattern bg-fixed pb-24">
        <div class="max-w-7xl mx-auto px-6 py-8 md:py-12 flex flex-col gap-8">
            <div class="flex flex-col gap-2">
                <h2 class="text-3xl font-extrabold text-text-main dark:text-white tracking-tight">Add Incoming Inventory
                </h2>
                <p class="text-text-muted">Manage your stock levels and track new supplies.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div
                        class="bg-white/50 dark:bg-card-dark/50 rounded-xl p-6 border border-dashed border-gray-300 dark:border-gray-700 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div>
                            <h4 class="font-bold text-text-main dark:text-white">Is this a new product?</h4>
                            <p class="text-sm text-text-muted">If the item ID doesn't exist, create a new record.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openComboBuilder()"
                                class="px-6 py-2.5 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-text-main dark:text-white font-medium hover:border-accent-teal hover:text-accent-teal transition-all shadow-sm flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">layers</span>
                                Create Combo
                            </button>
                            <button onclick="openCreateStockModal()"
                                class="px-6 py-2.5 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-text-main dark:text-white font-medium hover:border-primary hover:text-primary transition-all shadow-sm flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">add</span>
                                Create New Item
                            </button>
                        </div>
                    </div>
                    <div
                        class="bg-card-light dark:bg-card-dark rounded-2xl shadow-[0_8px_30px_-8px_rgba(0,0,0,0.08)] p-6 md:p-8 bg-subtle-fabric border border-[#e8e4e0] dark:border-gray-800">
                        <h3 class="text-xl font-bold text-text-main dark:text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">inventory</span>
                            Restock Existing Item
                        </h3>
                        <form class="flex flex-col gap-6" onsubmit="event.preventDefault();">
                            <div class="relative group z-20">
                                <label class="block text-sm font-medium text-text-muted mb-2">Find Product</label>
                                <div class="relative">
                                    <span
                                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-text-muted">search</span>
                                    <input id="restockSearchInput" onkeyup="handleRestockSearch()"
                                        class="w-full pl-11 pr-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-primary focus:border-primary transition-all text-text-main dark:text-white placeholder:text-text-muted/70"
                                        placeholder="Search product by name or ID..." type="text" autocomplete="off" />
                                    <!-- Search Results Dropdown -->
                                    <div id="restockSearchResults"
                                        class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 max-h-60 overflow-y-auto hidden z-30">
                                        <!-- Results injected here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Product Display Card (Hidden by default until selected) -->
                            <div id="restockProductCard"
                                class="hidden bg-primary-soft/50 dark:bg-gray-800/50 rounded-xl p-4 flex items-center gap-4 border border-primary/10 relative">
                                <input type="hidden" id="restockItemId">
                                <input type="hidden" id="restockSalePrice">
                                <input type="hidden" id="restockPurchasePrice">

                                <div id="restockImageContainer"
                                    class="h-16 w-16 rounded-lg bg-white dark:bg-gray-700 shadow-sm overflow-hidden shrink-0 p-1 flex items-center justify-center">
                                    <!-- Image injected here -->
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 id="restockProductName"
                                        class="font-bold text-text-main dark:text-white text-lg truncate">Product Name
                                    </h4>
                                    <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm mt-1">
                                        <span id="restockDisplayId" class="text-text-muted">ID: #...</span>
                                        <span class="hidden sm:inline w-1 h-1 rounded-full bg-gray-300"></span>
                                        <span id="restockCurrentStock" class="text-primary font-medium">Current Stock:
                                            -</span>
                                    </div>
                                </div>
                                <button onclick="clearRestockSelection()"
                                    class="text-text-muted hover:text-coral-orange transition-colors p-2 rounded-full hover:bg-white/50"
                                    type="button">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-text-muted mb-2">Quantity to
                                        Add</label>
                                    <div
                                        class="flex items-center rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden shadow-sm">
                                        <button onclick="document.getElementById('restockQuantity').stepDown()"
                                            class="px-5 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 text-text-muted transition-colors border-r border-gray-100 dark:border-gray-700"
                                            type="button">
                                            <span class="material-symbols-outlined text-sm">remove</span>
                                        </button>
                                        <input id="restockQuantity"
                                            class="flex-1 text-center border-none bg-transparent focus:ring-0 text-xl font-bold text-text-main dark:text-white h-full p-0 appearance-none"
                                            type="number" value="10" />
                                        <button onclick="document.getElementById('restockQuantity').stepUp()"
                                            class="px-5 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 text-text-muted transition-colors border-l border-gray-100 dark:border-gray-700"
                                            type="button">
                                            <span class="material-symbols-outlined text-sm">add</span>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-text-muted mb-2">Date Received</label>
                                    <div class="relative">
                                        <input id="restockDate"
                                            class="w-full px-4 py-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-primary focus:border-primary text-text-main dark:text-white shadow-sm"
                                            type="date" />
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-2">Supplier / Notes <span
                                        class="text-xs text-text-muted/70 font-normal">(Optional)</span></label>
                                <textarea id="restockNotes"
                                    class="w-full px-4 py-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-primary focus:border-primary text-text-main dark:text-white placeholder:text-text-muted/70 resize-none shadow-sm"
                                    placeholder="e.g. Order #4402 from WoolWholesale" rows="3"></textarea>
                            </div>
                            <button onclick="submitRestock()"
                                class="w-full py-4 rounded-xl bg-coral-orange hover:bg-coral-orange/90 text-white font-bold text-lg shadow-lg shadow-coral-orange/20 transition-all transform hover:-translate-y-0.5 mt-2 flex items-center justify-center gap-2"
                                type="button">
                                <span class="material-symbols-outlined">check_circle</span>
                                Confirm Restock
                            </button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-1">
                    <div
                        class="bg-card-light dark:bg-card-dark rounded-2xl shadow-sm p-6 bg-subtle-fabric sticky top-28 border border-[#e8e4e0] dark:border-gray-800">
                        <h3 class="text-lg font-bold text-text-main dark:text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-accent-teal">history</span>
                            Recently Added
                        </h3>
                        <div id="recentStockContainer" class="flex flex-col gap-4">
                            <div
                                class="flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer group">
                                <div
                                    class="h-10 w-10 rounded-lg bg-accent-sage/20 flex items-center justify-center text-accent-sage shrink-0">
                                    <span class="material-symbols-outlined text-xl">inventory_2</span>
                                </div>
                                <div class="min-w-0">
                                    <p
                                        class="text-sm font-bold text-text-main dark:text-white group-hover:text-primary transition-colors truncate">
                                        Acrylic Yarn - Blue</p>
                                    <p class="text-xs text-text-muted mt-0.5">Added 2 hours ago • <span
                                            class="text-accent-teal font-medium">+20</span></p>
                                </div>
                            </div>
                            <div
                                class="flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer group">
                                <div
                                    class="h-10 w-10 rounded-lg bg-accent-rose/20 flex items-center justify-center text-accent-rose shrink-0">
                                    <span class="material-symbols-outlined text-xl">inventory_2</span>
                                </div>
                                <div class="min-w-0">
                                    <p
                                        class="text-sm font-bold text-text-main dark:text-white group-hover:text-primary transition-colors truncate">
                                        Crochet Hook 4mm</p>
                                    <p class="text-xs text-text-muted mt-0.5">Added yesterday • <span
                                            class="text-accent-teal font-medium">+5</span></p>
                                </div>
                            </div>
                            <div
                                class="flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer group">
                                <div
                                    class="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary shrink-0">
                                    <span class="material-symbols-outlined text-xl">inventory_2</span>
                                </div>
                                <div class="min-w-0">
                                    <p
                                        class="text-sm font-bold text-text-main dark:text-white group-hover:text-primary transition-colors truncate">
                                        Safety Eyes - 8mm</p>
                                    <p class="text-xs text-text-muted mt-0.5">Oct 22 • <span
                                            class="text-accent-teal font-medium">+100</span></p>
                                </div>
                            </div>
                        </div>
                        <button onclick="openHistoryModal()"
                            class="w-full mt-6 text-sm font-medium text-text-muted hover:text-primary transition-colors py-2 border-t border-gray-100 dark:border-gray-700">
                            View All History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer
        class="fixed bottom-0 left-0 w-full bg-white dark:bg-card-dark border-t border-[#e8e4e0] dark:border-gray-800 py-3 md:py-4 z-50">
        <div
            class="max-w-7xl mx-auto flex overflow-x-auto md:justify-around items-center text-xs md:text-sm gap-8 px-4 scrollbar-hide">
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="index.html">
                <span class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">home</span>
                <span class="font-medium">Home</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-primary dark:text-primary transition-colors group"
                href="inventory.html">
                <span class="material-symbols-outlined text-lg transform scale-110">add_box</span>
                <span class="font-bold">Add Stock</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="sales.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">trending_up</span>
                <span class="font-medium">Sales</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="classes.html">
                <span class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">school</span>
                <span class="font-medium">Classes</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="statement.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">receipt_long</span>
                <span class="font-medium">Statement</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="accounting.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">account_balance_wallet</span>
                <span class="font-medium">Accounting</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="master.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">analytics</span>
                <span class="font-medium">Master</span>
            </a>
        </div>
    </footer>
    <!-- Stock Form Modal -->
    <div id="stockFormModal" class="fixed inset-0 z-[70] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('stockFormModal').classList.add('hidden')"></div>

        <!-- Modal Panel -->
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-card-light dark:bg-card-dark text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-xl border border-[#e8e4e0] dark:border-gray-800">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-800">
                        <div class="flex items-center gap-3">
                            <button onclick="document.getElementById('stockFormModal').classList.add('hidden')"
                                class="text-text-muted hover:text-text-main dark:hover:text-white transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                            <h3 class="text-lg font-bold text-text-main dark:text-white">Stock Form</h3>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="document.getElementById('stockFormModal').classList.add('hidden')"
                                class="px-4 py-2 rounded-lg text-sm font-medium text-text-main dark:text-white border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                                Cancel
                            </button>
                            <button onclick="saveStock()"
                                class="px-4 py-2 rounded-lg text-sm font-bold text-white bg-[#3B82F6] hover:bg-blue-600 shadow-sm transition-colors">
                                Save
                            </button>
                        </div>
                    </div>

                    <!-- Form Body -->
                    <form class="p-6 flex flex-col gap-6" onsubmit="event.preventDefault();">
                        <input type="hidden" id="formMode" value="create">
                        <!-- Image Upload -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Image<span
                                    class="text-blue-500">*</span></label>
                            <div
                                class="w-full h-32 border border-gray-200 dark:border-gray-700 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors bg-transparent relative overflow-hidden">
                                <input type="file" id="imageInput" accept="image/*"
                                    class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewImage(this)">
                                <div id="imagePreviewContainer" class="flex flex-col items-center justify-center">
                                    <span class="material-symbols-outlined text-text-muted text-2xl">photo_camera</span>
                                    <span class="text-xs text-text-muted mt-2">Click to upload</span>
                                </div>
                                <img id="imagePreview" class="absolute inset-0 w-full h-full object-cover hidden" />
                            </div>
                        </div>



                        <!-- Name -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Name</label>
                            <input type="text" id="nameInput"
                                class="w-full px-4 py-2.5 rounded-lg bg-transparent border border-gray-200 dark:border-gray-700 text-text-main dark:text-white focus:outline-none focus:border-[#3B82F6] transition-colors" />
                        </div>


                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Description</label>
                            <textarea rows="3" id="descriptionInput"
                                class="w-full px-4 py-2.5 rounded-lg bg-transparent border border-gray-200 dark:border-gray-700 text-text-main dark:text-white focus:outline-none focus:border-[#3B82F6] transition-colors resize-none"></textarea>
                        </div>

                        <!-- Purchase Price -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Purchase price<span
                                    class="text-blue-500">*</span></label>
                            <div
                                class="flex items-center border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                <div class="pl-4 pr-2 py-2.5 text-text-main dark:text-white font-medium select-none">Rs
                                </div>
                                <input type="number" value="0.00" id="purchasePriceInput"
                                    class="flex-1 bg-transparent border-none focus:ring-0 text-text-main dark:text-white p-0 h-full" />
                                <div class="flex items-center pr-2 gap-1">
                                    <button type="button"
                                        onclick="document.getElementById('purchasePriceInput').stepDown()"
                                        class="p-1 text-text-muted hover:text-white hover:bg-gray-700 rounded transition-colors">
                                        <span class="material-symbols-outlined text-lg">remove</span>
                                    </button>
                                    <button type="button"
                                        onclick="document.getElementById('purchasePriceInput').stepUp()"
                                        class="p-1 text-text-muted hover:text-white hover:bg-gray-700 rounded transition-colors">
                                        <span class="material-symbols-outlined text-lg">add</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Sale Price -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Sale price<span
                                    class="text-blue-500">*</span></label>
                            <div
                                class="flex items-center border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                <div class="pl-4 pr-2 py-2.5 text-text-main dark:text-white font-medium select-none">Rs
                                </div>
                                <input type="number" value="0.00" id="salePriceInput"
                                    class="flex-1 bg-transparent border-none focus:ring-0 text-text-main dark:text-white p-0 h-full" />
                                <div class="flex items-center pr-2 gap-1">
                                    <button type="button" onclick="document.getElementById('salePriceInput').stepDown()"
                                        class="p-1 text-text-muted hover:text-white hover:bg-gray-700 rounded transition-colors">
                                        <span class="material-symbols-outlined text-lg">remove</span>
                                    </button>
                                    <button type="button" onclick="document.getElementById('salePriceInput').stepUp()"
                                        class="p-1 text-text-muted hover:text-white hover:bg-gray-700 rounded transition-colors">
                                        <span class="material-symbols-outlined text-lg">add</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Item Count -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Item count<span
                                    class="text-blue-500">*</span></label>
                            <div
                                class="flex items-center border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden px-2 py-1.5">
                                <input type="number" value="0" id="countInput"
                                    class="flex-1 bg-transparent border-none focus:ring-0 text-text-main dark:text-white h-full ml-2" />
                                <div class="flex items-center gap-1">
                                    <button type="button" onclick="document.getElementById('countInput').stepDown()"
                                        class="p-1 text-text-muted hover:text-white hover:bg-gray-700 rounded transition-colors">
                                        <span class="material-symbols-outlined text-lg">remove</span>
                                    </button>
                                    <button type="button" onclick="document.getElementById('countInput').stepUp()"
                                        class="p-1 text-text-muted hover:text-white hover:bg-gray-700 rounded transition-colors">
                                        <span class="material-symbols-outlined text-lg">add</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- DateTime -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">DateTime<span
                                    class="text-blue-500">*</span></label>
                            <div class="relative">
                                <input type="date" id="dateInput"
                                    class="w-full px-4 py-2.5 rounded-lg bg-transparent border border-gray-200 dark:border-gray-700 text-text-main dark:text-white focus:outline-none focus:border-[#3B82F6] transition-colors" />
                                <span
                                    class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">calendar_today</span>
                            </div>
                        </div>

                        <!-- Item ID -->
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Item ID<span
                                    class="text-blue-500">*</span></label>
                            <input type="text" value="f596441e" id="itemIdInput"
                                class="w-full px-4 py-2.5 rounded-lg bg-transparent border border-gray-200 dark:border-gray-700 text-text-main dark:text-white focus:outline-none focus:border-[#3B82F6] transition-colors" />
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Combo Builder Modal -->
    <div id="comboBuilderModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('comboBuilderModal').classList.add('hidden')"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-card-light dark:bg-card-dark text-left shadow-xl transition-all w-full max-w-5xl border border-[#e8e4e0] dark:border-gray-800 flex flex-col md:flex-row h-[80vh]">

                    <!-- LEFT: Selection Panel -->
                    <div
                        class="w-full md:w-1/2 p-6 border-r border-[#e8e4e0] dark:border-gray-800 flex flex-col bg-subtle-fabric">
                        <h3 class="text-lg font-bold text-text-main dark:text-white mb-4">Select Items for Combo</h3>
                        <div class="relative mb-4">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">search</span>
                            <input type="text" id="comboSearchInput" onkeyup="filterComboItems()"
                                placeholder="Search items..."
                                class="w-full pl-10 pr-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-accent-teal">
                        </div>
                        <div id="comboItemsList" class="flex-1 overflow-y-auto space-y-2 pr-2">
                            <!-- Items injected here -->
                        </div>
                    </div>

                    <!-- RIGHT: Combo Details Form -->
                    <div class="w-full md:w-1/2 p-6 flex flex-col overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-text-main dark:text-white">Combo Details</h3>
                            <button onclick="document.getElementById('comboBuilderModal').classList.add('hidden')"
                                class="text-text-muted hover:text-text-main transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <form id="comboForm" class="flex flex-col gap-5" onsubmit="event.preventDefault();">
                            <!-- Selected Items Preview -->
                            <div
                                class="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                                <label
                                    class="block text-xs font-bold text-text-muted uppercase tracking-wider mb-2">Selected
                                    Content</label>
                                <div id="selectedItemsPreview"
                                    class="text-sm text-text-main dark:text-white empty:text-text-muted italic">
                                    No items selected.
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-2">Combo Name</label>
                                <input type="text" id="comboNameInput" placeholder="e.g. Starter Kit"
                                    class="w-full px-4 py-2.5 rounded-lg bg-transparent border border-gray-200 dark:border-gray-700 text-text-main dark:text-white focus:outline-none focus:border-accent-teal">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-text-muted mb-2">Sale Price</label>
                                    <div
                                        class="flex items-center border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                        <div class="pl-3 pr-2 py-2 text-text-muted text-sm select-none">Rs</div>
                                        <input type="number" id="comboSalePriceInput" value="0"
                                            class="flex-1 bg-transparent border-none focus:ring-0 text-text-main dark:text-white p-0 h-full">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-text-muted mb-2">Purchase Price</label>
                                    <div
                                        class="flex items-center border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                        <div class="pl-3 pr-2 py-2 text-text-muted text-sm select-none">Rs</div>
                                        <input type="number" id="comboPurchasePriceInput" value="0"
                                            class="flex-1 bg-transparent border-none focus:ring-0 text-text-main dark:text-white p-0 h-full">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-2">Combo Quantity</label>
                                <input type="number" id="comboCountInput" value="1"
                                    class="w-full px-4 py-2.5 rounded-lg bg-transparent border border-gray-200 dark:border-gray-700 text-text-main dark:text-white focus:outline-none focus:border-accent-teal">
                            </div>

                            <!-- Hidden inputs mimicking stock form -->
                            <input type="hidden" id="comboItemIdInput" value="">
                            <input type="hidden" id="comboDateInput" value="">

                            <div class="mt-auto pt-4">
                                <button onclick="saveCombo()"
                                    class="w-full py-3.5 rounded-xl bg-accent-teal hover:bg-accent-teal/90 text-white font-bold text-lg shadow-lg shadow-accent-teal/20 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined">layers</span>
                                    Create Combo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>



    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('historyModal').classList.add('hidden')"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-card-light dark:bg-card-dark text-left shadow-xl transition-all w-full max-w-4xl border border-[#e8e4e0] dark:border-gray-800">
                    <div class="flex items-center justify-between p-6 border-b border-gray-100 dark:border-gray-800">
                        <h3 class="text-xl font-bold text-text-main dark:text-white">Inventory History</h3>
                        <button onclick="document.getElementById('historyModal').classList.add('hidden')"
                            class="text-text-muted hover:text-text-main transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="p-0 overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead
                                class="text-xs text-text-muted uppercase bg-gray-50 dark:bg-gray-800/50 border-b border-gray-100 dark:border-gray-800">
                                <tr>
                                    <th class="px-6 py-4 font-bold">Item ID</th>
                                    <th class="px-6 py-4 font-bold">Date Time</th>
                                    <th class="px-6 py-4 font-bold">Name</th>
                                    <th class="px-6 py-4 font-bold">Description</th>
                                    <th class="px-6 py-4 font-bold">Image</th>
                                    <th class="px-6 py-4 font-bold hover:text-primary cursor-pointer"
                                        onclick="sortHistory('Sale price')">Sale Price</th>
                                    <th class="px-6 py-4 font-bold hover:text-primary cursor-pointer"
                                        onclick="sortHistory('Purchase price')">Purchase Price</th>
                                    <th class="px-6 py-4 font-bold hover:text-primary cursor-pointer"
                                        onclick="sortHistory('Item count')">Count</th>
                                    <th class="px-6 py-4 font-bold text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-gray-100 dark:divide-gray-800">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-text-muted">Loading history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // --- BACKEND INTEGRATION ---


        // Global Data Store
        let fullInventoryData = [];
        let currentSortColumn = 'dateTime'; // Default sort column
        let currentSortDirection = 'desc'; // Default sort direction

        // Set default date
        const dateInput = document.getElementById('dateInput');
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];

        // Generate Random ID if empty (or default)
        const itemIdInput = document.getElementById('itemIdInput');
        if (!itemIdInput.value || itemIdInput.value === 'f596441e') {
            itemIdInput.value = 'ID-' + Math.floor(Math.random() * 100000);
        }

        // Image Preview
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const container = document.getElementById('imagePreviewContainer');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    container.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Helper: Convert File to Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Helper to formatting Google Drive URLs for <img> tags
        function formatGoogleDriveUrl(url) {
            if (!url) return '';

            let id = '';

            // Extract ID from various formats
            if (url.includes('open?id=')) {
                const match = url.match(/id=([^&]+)/);
                if (match) id = match[1];
            } else if (url.includes('/file/d/')) {
                const match = url.match(/\/file\/d\/([^/]+)/);
                if (match) id = match[1];
            } else if (url.includes('uc?') && url.includes('id=')) {
                const match = url.match(/id=([^&]+)/);
                if (match) id = match[1];
            } else if (url.includes('lh3.googleusercontent.com/d/')) {
                const match = url.match(/\/d\/([^/]+)/);
                if (match) id = match[1];
            }

            // Return the lh3 format if ID found
            if (id) {
                return `https://lh3.googleusercontent.com/d/${id}`;
            }

            return url;
        }


        // Helper to safely parse dates (handles ISO and DD/MM/YYYY)
        function safeParseDate(dateStr) {
            if (!dateStr) return '';

            // Try standard parse first
            let date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date.toLocaleDateString();

            // Try DD/MM/YYYY
            if (typeof dateStr === 'string' && dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Assume DD/MM/YYYY
                    date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    if (!isNaN(date.getTime())) return date.toLocaleDateString();
                }
            }
            return dateStr; // parsing failed, return original
        }

        async function saveStock() {
            const btn = document.querySelector('button[onclick="saveStock()"]');
            const originalText = btn.innerText;

            try {
                // Gather Inputs
                const name = document.getElementById('nameInput').value;
                const description = document.getElementById('descriptionInput').value;
                const purchasePrice = document.getElementById('purchasePriceInput').value;
                const salePrice = document.getElementById('salePriceInput').value;
                const count = document.getElementById('countInput').value;
                const date = document.getElementById('dateInput').value;
                const itemId = document.getElementById('itemIdInput').value;
                const imageInput = document.getElementById('imageInput');

                if (!name || !purchasePrice || !salePrice || !count) {
                    alert('Please fill in required fields.');
                    return;
                }

                // DETERMINE MODE
                // If formMode is 'update', we use updateStock. Default is addStock.
                const modeInput = document.getElementById('formMode');
                const mode = modeInput ? modeInput.value : 'create';
                const action = mode === 'update' ? 'updateStock' : 'addStock';

                btn.innerText = mode === 'update' ? 'Updating...' : 'Uploading...';
                btn.disabled = true;

                // Handle Image
                let imageBase64 = '';
                let imageName = '';
                let imageType = '';

                if (imageInput.files.length > 0) {
                    const file = imageInput.files[0];
                    imageBase64 = await getBase64(file);
                    imageName = file.name;
                    imageType = file.type;
                }

                // Prepare Data
                const formData = new URLSearchParams();
                formData.append('action', action); // Use determined action

                formData.append('itemId', itemId);
                formData.append('dateTime', date);
                formData.append('name', name);
                formData.append('description', description);
                formData.append('salePrice', salePrice);
                formData.append('purchasePrice', purchasePrice);
                formData.append('count', count);

                // Add Image Params
                formData.append('image', imageBase64);
                formData.append('imageName', imageName);
                formData.append('imageType', imageType);

                // Send
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.result === 'success') {
                    alert(mode === 'update' ? 'Item updated successfully!' : 'Stock added successfully!');
                    document.getElementById('stockFormModal').classList.add('hidden');

                    // OPTIMISTIC UPDATE
                    // Note: Ideally we update the item in place if update, or add if create.
                    // For simplicity, we can just trigger a fetch.
                    // But let's try to update locally for responsiveness.

                    if (mode === 'update') {
                        const idx = fullInventoryData.findIndex(i => (i['Item ID'] || i.itemId) == itemId);
                        if (idx !== -1) {
                            fullInventoryData[idx] = {
                                ...fullInventoryData[idx],
                                'Item ID': itemId,
                                'Date Time': date, // Updated
                                'Name': name,
                                'Description': description,
                                'Sale price': salePrice,
                                'Purchase price': purchasePrice,
                                'Item count': count,
                                'Image': result.imageUrl || fullInventoryData[idx].Image // Keep old if no new
                            };
                        }
                    } else {
                        // Create
                        const newItem = {
                            'Item ID': itemId,
                            'Date Time': date,
                            'Name': name,
                            'Description': description,
                            'Image': result.imageUrl || '',
                            'Sale price': salePrice,
                            'Purchase price': purchasePrice,
                            'Item count': count
                        };
                        fullInventoryData.unshift(newItem);
                    }

                    renderRecentStock(fullInventoryData);
                    renderHistory(fullInventoryData);

                    // Reset Form
                    document.getElementById('nameInput').value = '';
                    document.getElementById('descriptionInput').value = '';
                    document.getElementById('countInput').value = '0';
                    document.getElementById('imageInput').value = '';
                    document.getElementById('imagePreview').classList.add('hidden');
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                    // Reset mode
                    if (modeInput) modeInput.value = 'create';

                    // Delayed refresh
                    setTimeout(() => {
                        fetchStock();
                    }, 5000);
                } else {
                    const errorMsg = typeof result.error === 'object' ? JSON.stringify(result.error) : result.error;
                    throw new Error(errorMsg);
                }

            } catch (error) {
                console.error('Error saving stock:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function fetchStock() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getInventory`);
                const data = await response.json();

                fullInventoryData = data; // Store globally
                renderRecentStock(data);
                if (!document.getElementById('historyModal').classList.contains('hidden')) {
                    renderHistory(fullInventoryData); // Render history with potentially sorted data
                }

            } catch (e) {
                console.error("Fetch stock error", e);
            }
        }

        function renderRecentStock(items) {
            const container = document.getElementById('recentStockContainer'); // Use specific ID
            if (!container) return;

            container.innerHTML = '';

            // Show last 3
            items.slice(-3).reverse().forEach(item => {
                const html = `
                    <div class="flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer group">
                        <div class="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary shrink-0 overflow-hidden">
                            ${item.Image ? `<img src="${formatGoogleDriveUrl(item.Image)}" referrerpolicy="no-referrer" class="w-full h-full object-cover">` : '<span class="material-symbols-outlined text-xl">inventory_2</span>'}
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-bold text-text-main dark:text-white group-hover:text-primary transition-colors truncate">
                                ${item.Name || item['Item Name'] || 'Item'}
                            </p>
                            <p class="text-xs text-text-muted mt-0.5">${safeParseDate(item['Date Time'] || item.Date)} • <span class="text-accent-teal font-medium">+${item['Item count'] || item.Count || 0}</span></p>
                        </div>
                    </div>
                 `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // History Logic
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            renderHistory(fullInventoryData);
        }

        function renderHistory(items) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-text-muted">No records found</td></tr>';
                return;
            }

            // Sort items based on currentSortColumn and currentSortDirection
            const sortedItems = [...items].sort((a, b) => {
                let valA = a[currentSortColumn] || '';
                let valB = b[currentSortColumn] || '';

                // Handle numbers
                if (currentSortColumn === 'Sale price' || currentSortColumn === 'Purchase price' || currentSortColumn === 'Item count' || currentSortColumn === 'Amount') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Show all items, newest first
            sortedItems.forEach(item => {
                const dateVal = item['Date Time'] || item.DateTime || item.Date || '';
                const idVal = item['Item ID'] || item.itemId || '';
                const nameVal = item.Name || item['Item Name'] || '';
                const descVal = item.Description || '';
                const saleVal = item['Sale price'] || item.salePrice || '0';
                const purchVal = item['Purchase price'] || item.purchasePrice || item.Amount || '0';
                const countVal = item['Item count'] || item.count || item.Count || '0';
                const imgVal = item.Image || item.image || '';

                const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <td class="px-6 py-4 text-text-muted font-mono text-xs">${idVal}</td>
                    <td class="px-6 py-4 text-text-main dark:text-gray-300 w-32">${safeParseDate(dateVal)}</td>
                    <td class="px-6 py-4 font-medium text-text-main dark:text-white">${nameVal}</td>
                    <td class="px-6 py-4 text-text-muted text-xs max-w-xs truncate" title="${descVal}">${descVal}</td>
                    <td class="px-6 py-4">
                        <div class="size-10 rounded-lg bg-gray-100 dark:bg-gray-800 overflow-hidden flex items-center justify-center">
                            ${imgVal ? `<img src="${formatGoogleDriveUrl(imgVal)}" referrerpolicy="no-referrer" class="w-full h-full object-cover">` : '<span class="material-symbols-outlined text-gray-400">image_not_supported</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-text-main dark:text-white">Rs ${saleVal}</td>
                    <td class="px-6 py-4 text-text-main dark:text-white">Rs ${purchVal}</td>
                    <td class="px-6 py-4 text-text-main dark:text-white font-bold">${countVal}</td>
                    <td class="px-6 py-4 flex items-center justify-center gap-2">
                        <button onclick="editStock('${idVal}')" class="p-2 rounded-lg text-text-muted hover:text-accent-teal hover:bg-accent-teal/10 transition-colors" title="Edit">
                            <span class="material-symbols-outlined text-lg">edit</span>
                        </button>
                        <button onclick="deleteStock('${idVal}')" class="p-2 rounded-lg text-text-muted hover:text-coral-orange hover:bg-coral-orange/10 transition-colors" title="Delete">
                            <span class="material-symbols-outlined text-lg">delete</span>
                        </button>
                    </td>
                </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- EDIT / DELETE LOGIC ---
        function editStock(id) {
            const item = fullInventoryData.find(i => (i['Item ID'] || i.itemId) == id);
            if (!item) return;

            // Populate Form
            document.getElementById('itemIdInput').value = item['Item ID'] || item.itemId;
            document.getElementById('dateInput').value = (item['Date Time'] || item.DateTime || '').split('T')[0];
            document.getElementById('nameInput').value = item.Name || item['Item Name'];
            document.getElementById('descriptionInput').value = item.Description || '';
            document.getElementById('salePriceInput').value = item['Sale price'] || item.salePrice;
            document.getElementById('purchasePriceInput').value = item['Purchase price'] || item.purchasePrice;
            document.getElementById('countInput').value = item['Item count'] || item.Count;

            // Image Preview
            const img = formatGoogleDriveUrl(item.Image || item.image);
            // Set Mode to UPDATE
            const modeInput = document.getElementById('formMode');
            if (modeInput) modeInput.value = 'update';

            // Lock Item ID
            document.getElementById('itemIdInput').readOnly = true;
            document.getElementById('itemIdInput').classList.add('bg-gray-100', 'dark:bg-gray-700');

            // Change Save Button Text
            const btn = document.querySelector('#stockFormModal button[onclick="saveStock()"]');
            if (btn) btn.innerHTML = 'Update Stock';

            const preview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('imagePreviewContainer');

            if (img) {
                preview.src = img;
                preview.classList.remove('hidden');
                previewContainer.classList.add('hidden');
            } else {
                preview.classList.add('hidden');
                previewContainer.classList.remove('hidden');
            }

            document.getElementById('stockFormModal').classList.remove('hidden');
        }

        function openCreateStockModal() {
            // Set Mode to CREATE
            const modeInput = document.getElementById('formMode');
            if (modeInput) modeInput.value = 'create';

            // Unlock Item ID and generate new random ID
            const idInput = document.getElementById('itemIdInput');
            idInput.readOnly = false;
            idInput.classList.remove('bg-gray-100', 'dark:bg-gray-700');
            idInput.value = 'ID-' + Math.floor(Math.random() * 100000);

            // Reset other fields
            document.getElementById('imageInput').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('purchasePriceInput').value = '0.00';
            document.getElementById('salePriceInput').value = '0.00';
            document.getElementById('countInput').value = '0';
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

            // Reset Image Preview
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imagePreviewContainer').classList.remove('hidden');

            // Change Button Text
            const btn = document.querySelector('#stockFormModal button[onclick="saveStock()"]');
            if (btn) btn.innerHTML = 'Save';

            document.getElementById('stockFormModal').classList.remove('hidden');
        }

        async function deleteStock(id) {
            if (!confirm(`Are you sure you want to delete item ${id}? This action cannot be undone.`)) return;

            try {
                // Optimistic UI update
                const originalData = [...fullInventoryData];
                fullInventoryData = fullInventoryData.filter(i => (i['Item ID'] || i.itemId) != id);
                renderHistory(fullInventoryData);

                const formData = new URLSearchParams();
                formData.append('action', 'deleteStock');
                formData.append('itemId', id);

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.result !== 'success') {
                    // Revert if failed
                    fullInventoryData = originalData;
                    renderHistory(fullInventoryData);
                    const errorMsg = typeof result.error === 'object' ? JSON.stringify(result.error) : result.error;
                    throw new Error(errorMsg || 'Server returned error');
                }

                alert('Item deleted successfully.');
                fetchStock(); // Refresh to be sure

            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete item: ' + error.message);
            }
        }

        function sortHistory(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc'; // Default to ascending for new column
            }
            renderHistory(fullInventoryData);
        }

        // COMBO BUILDER LOGIC
        let selectedComboItems = new Set();

        function openComboBuilder() {
            document.getElementById('comboBuilderModal').classList.remove('hidden');
            renderComboItems(fullInventoryData); // Render all items initially
            selectedComboItems.clear();
            updateComboPreview();

            // Set default date for combo
            document.getElementById('comboDateInput').value = new Date().toISOString().split('T')[0];
            // Set random ID for combo
            document.getElementById('comboItemIdInput').value = 'CMB-' + Math.floor(Math.random() * 100000);
        }

        function renderComboItems(items) {
            const container = document.getElementById('comboItemsList');
            container.innerHTML = '';

            items.forEach(item => {
                const id = item['Item ID'] || item.itemId;
                const name = item.Name || item['Item Name'];
                const img = formatGoogleDriveUrl(item.Image);
                const isSelected = selectedComboItems.has(id);

                const html = `
                    <div class="flex items-center gap-3 p-3 rounded-lg border border-gray-100 dark:border-gray-700 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer ${isSelected ? 'ring-2 ring-accent-teal bg-accent-teal/5' : ''}"
                        onclick="toggleComboItem('${id}')">
                        <div class="h-10 w-10 rounded bg-gray-100 dark:bg-gray-700 flex items-center justify-center overflow-hidden shrink-0">
                             ${img ? `<img src="${img}" class="w-full h-full object-cover">` : '<span class="material-symbols-outlined text-lg">inventory_2</span>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-text-main dark:text-white truncate">${name}</p>
                            <p class="text-xs text-text-muted">Stock: ${item['Item count'] || item.Count || 0}</p>
                        </div>
                        <div class="h-5 w-5 rounded border ${isSelected ? 'bg-accent-teal border-accent-teal' : 'border-gray-300 dark:border-gray-600'} flex items-center justify-center">
                            ${isSelected ? '<span class="material-symbols-outlined text-white text-sm">check</span>' : ''}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function filterComboItems() {
            const query = document.getElementById('comboSearchInput').value.toLowerCase();
            const filtered = fullInventoryData.filter(item => {
                const name = (item.Name || item['Item Name'] || '').toLowerCase();
                const id = (item['Item ID'] || item.itemId || '').toLowerCase();
                return name.includes(query) || id.includes(query);
            });
            renderComboItems(filtered);
        }

        function toggleComboItem(id) {
            if (selectedComboItems.has(id)) {
                selectedComboItems.delete(id);
            } else {
                selectedComboItems.add(id);
            }
            // Re-render to show selection state (inefficient but safe)
            filterComboItems();
            updateComboPreview();
        }

        function updateComboPreview() {
            const container = document.getElementById('selectedItemsPreview');
            const ids = Array.from(selectedComboItems);

            if (ids.length === 0) {
                container.innerHTML = 'No items selected.';
                return;
            }

            const names = ids.map(id => {
                const item = fullInventoryData.find(i => (i['Item ID'] || i.itemId) == id);
                return item ? (item.Name || item['Item Name']) : id;
            });

            container.innerHTML = names.join(', ');

            // Auto-calculate suggested prices (sum of parts)
            let totalSale = 0;
            let totalPurchase = 0;

            ids.forEach(id => {
                const item = fullInventoryData.find(i => (i['Item ID'] || i.itemId) == id);
                if (item) {
                    totalSale += parseFloat(item['Sale price'] || item.salePrice || 0);
                    totalPurchase += parseFloat(item['Purchase price'] || item.purchasePrice || 0);
                }
            });

            // Only update if input is pristine (0) or user hasn't manually edited? 
            // For now, let's just update as suggestion
            document.getElementById('comboSalePriceInput').value = totalSale;
            document.getElementById('comboPurchasePriceInput').value = totalPurchase;
        }

        async function saveCombo() {
            const btn = document.querySelector('button[onclick="saveCombo()"]');
            const originalText = btn.innerText;

            try {
                // Gather Combo Inputs
                let name = document.getElementById('comboNameInput').value;
                const salePrice = document.getElementById('comboSalePriceInput').value;
                const purchasePrice = document.getElementById('comboPurchasePriceInput').value;
                const count = document.getElementById('comboCountInput').value;
                const itemId = document.getElementById('comboItemIdInput').value;
                const date = document.getElementById('comboDateInput').value;

                if (!name || !salePrice || !count || selectedComboItems.size === 0) {
                    alert('Please provide a name, price, quantity, and select at least one item.');
                    return;
                }

                // Construct Description
                const itemNames = Array.from(selectedComboItems).map(id => {
                    const item = fullInventoryData.find(i => (i['Item ID'] || i.itemId) == id);
                    return item ? (item.Name || item['Item Name']) : id;
                });

                const description = `[COMBO SET] Includes: ${itemNames.join(', ')}`;

                // Append [Combo] tag to name if not present
                if (!name.toLowerCase().includes('[combo]')) {
                    name = `${name} [Combo]`;
                }

                btn.innerText = 'Creating...';
                btn.disabled = true;

                // Prepare Data using standard schema
                const formData = new URLSearchParams();
                formData.append('action', 'addStock');
                formData.append('itemId', itemId);
                formData.append('dateTime', date);
                formData.append('name', name);
                formData.append('description', description);
                formData.append('salePrice', salePrice);
                formData.append('purchasePrice', purchasePrice);
                formData.append('count', count);
                // No image for now, or maybe generic combo image?
                formData.append('image', '');
                formData.append('imageName', '');
                formData.append('imageType', '');

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.result === 'success') {
                    alert('Combo Created Successfully!');
                    document.getElementById('comboBuilderModal').classList.add('hidden');

                    // Optimistic Update
                    const newCombo = {
                        'Item ID': itemId,
                        'Date Time': date,
                        'Name': name,
                        'Description': description,
                        'Image': '',
                        'Sale price': salePrice,
                        'Purchase price': purchasePrice,
                        'Item count': count
                    };
                    fullInventoryData.unshift(newCombo);
                    renderRecentStock(fullInventoryData);
                    renderHistory(fullInventoryData);

                    // Helper: delayed refresh
                    setTimeout(() => fetchStock(), 3000);

                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Error saving combo:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }


        // --- RESTOCK LOGIC ---
        let restockSearchTimeout;

        function handleRestockSearch() {
            clearTimeout(restockSearchTimeout);
            const query = document.getElementById('restockSearchInput').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('restockSearchResults');

            if (query.length === 0) {
                resultsContainer.classList.add('hidden');
                return;
            }

            restockSearchTimeout = setTimeout(() => {
                const filtered = fullInventoryData.filter(item => {
                    const name = (item.Name || item['Item Name'] || '').toLowerCase();
                    const id = (item['Item ID'] || item.itemId || '').toLowerCase();
                    return name.includes(query) || id.includes(query);
                });

                resultsContainer.innerHTML = '';
                if (filtered.length > 0) {
                    filtered.forEach(item => {
                        const id = item['Item ID'] || item.itemId;
                        const name = item.Name || item['Item Name'];
                        const img = formatGoogleDriveUrl(item.Image);
                        const stock = item['Item count'] || item.Count || 0;

                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-50 dark:border-gray-700 last:border-none';
                        div.onclick = () => selectRestockItem(item);
                        div.innerHTML = `
                            <div class="h-10 w-10 rounded bg-gray-100 dark:bg-gray-600 flex items-center justify-center overflow-hidden shrink-0">
                                ${img ? `<img src="${img}" class="w-full h-full object-cover">` : '<span class="material-symbols-outlined text-gray-400">inventory_2</span>'}
                            </div>
                            <div>
                                <p class="text-sm font-bold text-text-main dark:text-white">${name}</p>
                                <p class="text-xs text-text-muted">ID: ${id} • Stock: ${stock}</p>
                            </div>
                        `;
                        resultsContainer.appendChild(div);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.innerHTML = '<div class="p-3 text-sm text-text-muted text-center">No items found</div>';
                    resultsContainer.classList.remove('hidden');
                }
            }, 300);
        }

        function selectRestockItem(item) {
            document.getElementById('restockSearchInput').value = '';
            document.getElementById('restockSearchResults').classList.add('hidden');

            const id = item['Item ID'] || item.itemId;
            const name = item.Name || item['Item Name'];
            const img = formatGoogleDriveUrl(item.Image);
            const stock = item['Item count'] || item.Count || 0;
            const salePrice = item['Sale price'] || item.salePrice || 0;
            const purchasePrice = item['Purchase price'] || item.purchasePrice || 0;

            // Fill hidden and display fields
            document.getElementById('restockItemId').value = id;
            document.getElementById('restockSalePrice').value = salePrice;
            document.getElementById('restockPurchasePrice').value = purchasePrice;

            document.getElementById('restockProductName').innerText = name;
            document.getElementById('restockDisplayId').innerText = `ID: #${id}`;
            const restockCurrentStockEl = document.getElementById('restockCurrentStock');
            restockCurrentStockEl.innerText = `Current Stock: ${stock}`;
            restockCurrentStockEl.dataset.count = stock; // Store for calculation

            const imgContainer = document.getElementById('restockImageContainer');
            if (img) {
                imgContainer.innerHTML = `<img src="${img}" referrerpolicy="no-referrer" class="w-full h-full object-cover">`;
            } else {
                imgContainer.innerHTML = `<span class="material-symbols-outlined text-coral-orange/60 text-2xl">checkroi</span>`;
            }

            document.getElementById('restockProductCard').classList.remove('hidden');
        }

        function clearRestockSelection() {
            document.getElementById('restockProductCard').classList.add('hidden');
            document.getElementById('restockItemId').value = '';
        }

        async function submitRestock() {
            const btn = document.querySelector('button[onclick="submitRestock()"]');
            const originalText = btn.innerHTML;

            const itemId = document.getElementById('restockItemId').value;
            const quantity = document.getElementById('restockQuantity').value;
            const date = document.getElementById('restockDate').value;
            const notes = document.getElementById('restockNotes').value;
            const salePrice = document.getElementById('restockSalePrice').value;
            const purchasePrice = document.getElementById('restockPurchasePrice').value;

            if (!itemId) {
                alert('Please select a product to restock.');
                return;
            }

            // Calculate NEW TOTAL
            const currentStock = parseInt(document.getElementById('restockCurrentStock').dataset.count || 0);
            const addedQty = parseInt(quantity || 0);
            const newTotalCount = currentStock + addedQty;

            try {
                btn.disabled = true;
                btn.innerHTML = `<span class="material-symbols-outlined animate-spin">refresh</span> Processing...`;

                // Prepare Data using standard schema
                const formData = new URLSearchParams();
                formData.append('action', 'updateStock');
                formData.append('itemId', itemId);
                formData.append('dateTime', date);
                // Important: Use existing name for history record
                const name = document.getElementById('restockProductName').innerText;
                formData.append('name', name);
                formData.append('description', `[RESTOCK] ${notes}`);
                formData.append('salePrice', salePrice);
                formData.append('purchasePrice', purchasePrice);
                formData.append('count', newTotalCount);
                // No image change for restock
                formData.append('image', '');

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.result === 'success') {
                    alert('Restock Successful!');
                    clearRestockSelection();
                    document.getElementById('restockQuantity').value = 10;
                    document.getElementById('restockNotes').value = '';

                    // Trigger refresh
                    fetchStock();
                } else {
                    const errorMsg = typeof result.error === 'object' ? JSON.stringify(result.error) : result.error;
                    throw new Error(errorMsg);
                }

            } catch (error) {
                console.error('Error submitting restock:', error);
                alert('Restock failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Set default date for restock
        document.getElementById('restockDate').value = new Date().toISOString().split('T')[0];

        // Initial Fetch
        fetchStock();

        // Missing helper function
        function openCreateStockModal() {
            // Reset fields
            document.getElementById('itemIdInput').value = 'ID-' + Math.floor(Math.random() * 100000);
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('nameInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('salePriceInput').value = '0';
            document.getElementById('purchasePriceInput').value = '0';
            document.getElementById('countInput').value = '0';
            document.getElementById('imagePreview').innerHTML = `<span class="material-symbols-outlined text-4xl text-text-muted">add_a_photo</span><span class="text-xs text-text-muted mt-2">Click to Upload</span>`;

            // Set mode to create (if we were using formMode, but we simplified logic to just use saveStock)
            // Ideally we'd have a hidden input for mode, but for now just clear and show works.

            // Reset button text
            const btn = document.querySelector('#stockFormModal button[onclick="saveStock()"]');
            if (btn) btn.innerText = 'Save Item';

            document.getElementById('stockFormModal').classList.remove('hidden');
        }

    </script>
</body>

</html>