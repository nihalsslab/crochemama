<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CrocheMama Sales</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#b65d00",
                        "primary-soft": "#FDECE7",
                        "accent-sage": "#8da399",
                        "accent-teal": "#4b8f8c",
                        "accent-rose": "#d6aeb4",
                        "background-warm": "#F9F7F2",
                        "background-dark": "#23190f",
                        "card-light": "#ffffff",
                        "card-dark": "#2a1b1f",
                        "text-main": "#4A3B37",
                        "text-muted": "#8C807B",
                        "peach": "#F4A48C",
                        "deep-terracotta": "#E05A4A",
                        "soft-sage": "#AAB396"
                    },
                    fontFamily: {
                        display: "Plus Jakarta Sans"
                    },
                    backgroundImage: {
                        "knit-pattern": "url(\"data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v2.5h20zm0-11V7H0v2.5h20zM20 40V37.5H0V40h20zM40 20.5V18H20v2.5h20zm0-11V7H20v2.5h20zM40 40V37.5H20V40h20z' fill='%23e8e4e0' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E\")",
                        "subtle-fabric": "url(\"data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23dcd6d1' fill-opacity='0.1'%3E%3Cpath d='M0 0h16v16H0V0zm1 1h14v14H1V1z'/%3E%3Cpath d='M2 0h1v16H2V0zm4 0h1v16H6V0zm4 0h1v16h-1V0zm4 0h1v16h-1V0zM0 2h16v1H0V2zm0 4h16v1H0V6zm0 4h16v1H0v10zm0 4h16v1H0v14z'/%3C/g%3E%3C/svg%3E\")"
                    },
                    borderRadius: {
                        DEFAULT: "0.125rem",
                        lg: "0.5rem",
                        xl: "1rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .font-display {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .card-shadow-soft {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body
    class="bg-background-warm dark:bg-background-dark text-text-main dark:text-gray-100 min-h-screen flex flex-col font-display">
    <header
        class="sticky top-0 z-50 w-full bg-white/80 dark:bg-card-dark/90 backdrop-blur-sm border-b border-[#e8e4e0] dark:border-gray-800 px-6 py-4 transition-all duration-300">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="size-10 bg-primary/10 rounded-full flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined" style="font-size: 24px;">gesture</span>
                </div>
                <h1 class="text-xl md:text-2xl font-extrabold tracking-tight text-text-main dark:text-white">CrocheMama
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative hidden md:block w-72 lg:w-96 transition-all duration-300">
                    <span
                        class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-text-muted text-2xl">search</span>
                    <input aria-label="Search dashboard"
                        class="w-full pl-14 pr-24 py-3.5 rounded-full bg-white dark:bg-card-dark border border-gray-100 dark:border-gray-700 shadow-sm text-base text-text-main dark:text-white placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all hover:shadow-md"
                        placeholder="Search..." type="text" />
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1">
                        <a href="notification.html"
                            class="p-2 text-text-muted hover:text-primary transition-colors rounded-full hover:bg-gray-50 dark:hover:bg-gray-800 relative">
                            <span class="material-symbols-outlined text-xl">notifications</span>
                            <span
                                class="absolute top-2 right-2 size-2 bg-primary rounded-full ring-1 ring-white dark:ring-card-dark"></span>
                        </a>
                        <button
                            class="p-2 text-text-muted hover:text-primary transition-colors rounded-full hover:bg-gray-50 dark:hover:bg-gray-800">
                            <span class="material-symbols-outlined text-xl">person</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="flex-1 w-full bg-knit-pattern bg-fixed pb-24">
        <div class="max-w-7xl mx-auto px-6 py-8 md:py-10 flex flex-col gap-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-text-main dark:text-white">New Sale</h2>
                    <p class="text-text-muted mt-1">Point of Sale &amp; Transaction History</p>
                </div>
                <div
                    class="text-sm font-medium text-text-muted bg-white/60 dark:bg-card-dark/60 px-4 py-2 rounded-xl backdrop-blur-sm border border-gray-100 dark:border-gray-700 shadow-sm">
                    Today: <span id="currentDateDisplay" class="text-primary font-bold">...</span>
                </div>
            </div>
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div
                        class="bg-card-light dark:bg-card-dark rounded-2xl card-shadow-soft p-6 bg-subtle-fabric border border-transparent dark:border-gray-800">
                        <label class="block text-sm font-semibold text-text-muted mb-2">Add Items</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <span
                                    class="material-symbols-outlined text-text-muted group-focus-within:text-primary transition-colors">qr_code_scanner</span>
                            </div>
                            <input id="productSearchInput" onkeyup="handleProductSearch()"
                                class="w-full pl-12 pr-4 py-4 rounded-xl bg-background-warm dark:bg-gray-800 border-none ring-1 ring-gray-200 dark:ring-gray-700 focus:ring-2 focus:ring-peach placeholder:text-text-muted/70 text-lg transition-all shadow-sm"
                                placeholder="Scan Item or Search Product..." type="text" />
                            <button onclick="handleProductSearch()"
                                class="absolute inset-y-2 right-2 px-4 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-primary/90 transition-colors shadow-sm">
                                Search
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center justify-between px-1">
                            <h3 class="text-lg font-bold text-text-main dark:text-white">Popular Items</h3>
                            <button id="viewAllProductsBtn" onclick="toggleViewAllProducts()"
                                class="text-sm text-primary font-semibold hover:underline">View All</button>
                        </div>
                        <div id="productsContainer" class="flex gap-4 overflow-x-auto scrollbar-hide pb-4 -mx-2 px-2">
                            <!-- Products will be loaded here -->
                            <div class="min-w-[160px] p-6 text-text-muted text-sm text-center">Loading products...</div>
                        </div>
                    </div>
                </div>
        </div>
        <div class="lg:col-span-1">
            <div
                class="bg-card-light dark:bg-card-dark rounded-2xl card-shadow-soft h-full flex flex-col border border-gray-100 dark:border-gray-800 bg-subtle-fabric relative overflow-hidden">
                <div
                    class="p-6 border-b border-gray-100 dark:border-gray-700 bg-white/50 dark:bg-transparent backdrop-blur-sm">
                    <h3 class="text-xl font-bold text-text-main dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">shopping_cart</span>
                        Current Cart
                    </h3>
                    <p class="text-sm text-text-muted mt-1">Order #8834</p>
                </div>
                <div id="cartContainer"
                    class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 max-h-[300px] lg:max-h-none">
                    <div class="text-center text-text-muted text-sm py-8">Your cart is empty</div>
                </div>
            </div>
            <div
                class="p-6 bg-background-warm/50 dark:bg-gray-800/50 mt-auto border-t border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-2 text-sm text-text-muted">
                    <span id="subtotalLabel">Subtotal (0 items)</span>
                    <span id="subtotalDisplay">₹0</span>
                </div>
                <div class="flex justify-between items-center mb-4 text-sm text-text-muted">
                    <span>Tax (5%)</span>
                    <span id="taxDisplay">₹0</span>
                </div>
                <div class="flex justify-between items-center mb-6 text-xl font-bold text-text-main dark:text-white">
                    <span>Total</span>
                    <span id="totalDisplay">₹0</span>
                </div>
                <button onclick="saveSale()"
                    class="w-full py-3.5 px-4 bg-peach hover:bg-deep-terracotta text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:shadow-orange-200 dark:hover:shadow-none transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">
                    Complete Sale
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
        </div>
        </section>
        <section class="mt-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-text-main dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">history</span>
                    Recent Transactions
                </h3>
                <button onclick="openSalesHistoryModal()"
                    class="text-sm font-medium text-text-muted hover:text-primary flex items-center gap-1">
                    View All History <span class="material-symbols-outlined text-base">chevron_right</span>
                </button>
            </div>
            <div
                class="bg-card-light dark:bg-card-dark rounded-2xl card-shadow-soft border border-gray-100 dark:border-gray-800 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50/50 dark:bg-gray-800/50 border-b border-gray-100 dark:border-gray-700">
                                <th class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider">
                                    Date/Time</th>
                                <th class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider">Items
                                </th>
                                <th class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider">
                                    Sale ID</th>
                                <th
                                    class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider text-right">
                                    Amount</th>
                                <th
                                    class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider text-center">
                                    Receipt</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactionsBody" class="divide-y divide-gray-100 dark:divide-gray-800">
                            <!-- Populated by JS -->
                            <tr class="hover:bg-background-warm/50 dark:hover:bg-gray-800/30 transition-colors">
                                <td colspan="5" class="p-4 text-center text-text-muted">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        </div>
    </main>

    <!-- Sales History Modal -->
    <div id="salesHistoryModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('salesHistoryModal').classList.add('hidden')"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-card-light dark:bg-card-dark text-left shadow-xl transition-all w-full max-w-5xl border border-[#e8e4e0] dark:border-gray-800 flex flex-col h-[85vh]">

                    <!-- Header -->
                    <div
                        class="p-6 border-b border-[#e8e4e0] dark:border-gray-800 flex items-center justify-between bg-subtle-fabric">
                        <h3 class="text-2xl font-bold text-text-main dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">history</span>
                            Sales History
                        </h3>
                        <button onclick="document.getElementById('salesHistoryModal').classList.add('hidden')"
                            class="text-text-muted hover:text-text-main dark:text-gray-400 dark:hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-2xl">close</span>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="p-0 overflow-auto flex-1 bg-white dark:bg-card-dark">
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="sticky top-0 bg-gray-50/95 dark:bg-gray-800/95 backdrop-blur-sm z-10 border-b border-gray-100 dark:border-gray-700">
                                <tr>
                                    <th class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider">Date
                                    </th>
                                    <th class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider">Sale
                                        ID</th>
                                    <th class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider">Items
                                    </th>
                                    <th
                                        class="p-4 text-xs font-semibold uppercase text-text-muted tracking-wider text-right">
                                        Total</th>
                                </tr>
                            </thead>
                            <tbody id="fullSalesGraphBody" class="divide-y divide-gray-100 dark:divide-gray-800">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer
        class="fixed bottom-0 left-0 w-full bg-white dark:bg-card-dark border-t border-[#e8e4e0] dark:border-gray-800 py-4 px-6 md:px-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-around items-center text-sm">
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="index.html">
                <span class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">home</span>
                <span class="font-medium">Home</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="inventory.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">add_box</span>
                <span class="font-medium">Add Stock</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-primary dark:text-primary transition-colors group"
                href="sales.html">
                <span class="material-symbols-outlined text-lg transform scale-110">trending_up</span>
                <span class="font-bold">Sales</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="classes.html">
                <span class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">school</span>
                <span class="font-medium">Classes</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="statement.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">receipt_long</span>
                <span class="font-medium">Statement</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="accounting.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">account_balance_wallet</span>
                <span class="font-medium">Accounting</span>
            </a>
            <a class="flex flex-col items-center gap-1 text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors group"
                href="master.html">
                <span
                    class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">analytics</span>
                <span class="font-medium">Master</span>
            </a>
        </div>
    </footer>
    <script src="config.js"></script>
    <script>
        // --- BACKEND INTEGRATION ---


        let cart = [];
        let products = [];

        // Fetch Products from Inventory
        async function fetchProducts() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getInventory`);
                const data = await response.json();
                products = data.reverse(); // Show newest first
                renderProducts(products);
            } catch (error) {
                console.error("Fetch products error:", error);
                document.getElementById('productsContainer').innerHTML = '<div class="p-6 text-red-500">Error loading products</div>';
            }
        }

        // Helper to formatting Google Drive URLs for <img> tags
        function formatGoogleDriveUrl(url) {
            if (!url) return '';

            let id = '';

            // Extract ID from various formats
            if (url.includes('open?id=')) {
                const match = url.match(/id=([^&]+)/);
                if (match) id = match[1];
            } else if (url.includes('/file/d/')) {
                const match = url.match(/\/file\/d\/([^/]+)/);
                if (match) id = match[1];
            } else if (url.includes('uc?') && url.includes('id=')) {
                const match = url.match(/id=([^&]+)/);
                if (match) id = match[1];
            } else if (url.includes('lh3.googleusercontent.com/d/')) {
                const match = url.match(/\/d\/([^/]+)/);
                if (match) id = match[1];
            }

            // Return the lh3 format if ID found
            if (id) {
                return `https://lh3.googleusercontent.com/d/${id}`;
            }

            return url;
        }


        function renderProducts(list) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div class="p-6 text-text-muted">No products found</div>';
                return;
            }

            list.forEach(item => {
                // Backend Headers: Item ID, Name, Image, Sale price, Item count
                const price = item['Sale price'] || 0;
                const name = item['Name'] || 'Product';
                const image = item['Image'] || '';
                const stock = item['Item count'] || 0;
                const id = item['Item ID'] || '';

                const html = `
                <div onclick="addToCart('${id}')"
                    class="min-w-[160px] w-40 bg-card-light dark:bg-card-dark rounded-xl p-3 shadow-sm hover:shadow-md transition-all cursor-pointer border border-gray-100 dark:border-gray-800 group shrink-0">
                    <div class="aspect-square w-full rounded-lg bg-primary-soft/50 dark:bg-gray-700 mb-3 overflow-hidden relative">
                         ${image ? `<img src="${formatGoogleDriveUrl(image)}" referrerpolicy="no-referrer" class="w-full h-full object-cover">` :
                        `<div class="absolute inset-0 flex items-center justify-center text-peach group-hover:scale-110 transition-transform duration-300">
                            <span class="material-symbols-outlined text-4xl">checkroom</span>
                         </div>`}
                    </div>
                    <h4 class="font-bold text-text-main dark:text-white truncate">${name}</h4>
                    <p class="text-text-muted text-xs">Stock: ${stock}</p>
                    <p class="text-primary font-bold mt-1">₹${price}</p>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function addToCart(id) {
            const product = products.find(p => p['Item ID'] === id);
            if (!product) return;

            const existing = cart.find(c => c.id === id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: id,
                    name: product['Name'] || 'Product',
                    price: parseFloat(product['Sale price'] || 0),
                    qty: 1
                });
            }
            renderCart();
        }

        function removeFromCart(id) {
            cart = cart.filter(c => c.id !== id);
            renderCart();
        }

        function updateQty(id, change) {
            const item = cart.find(c => c.id === id);
            if (item) {
                item.qty += change;
                if (item.qty <= 0) removeFromCart(id);
                else renderCart();
            }
        }

        function renderCart() {
            const container = document.getElementById('cartContainer');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center text-text-muted text-sm py-8">Your cart is empty</div>';
                updateTotals(0);
                return;
            }

            container.innerHTML = '';
            let subtotal = 0;

            cart.forEach(item => {
                subtotal += item.price * item.qty;
                const html = `
                <div class="flex items-start gap-3 pb-4 border-b border-dashed border-gray-200 dark:border-gray-700 last:border-0">
                    <div class="size-12 rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 flex items-center justify-center">
                        <span class="material-symbols-outlined text-gray-400">checkroom</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-text-main dark:text-white text-sm">${item.name}</h4>
                            <p class="font-bold text-text-main dark:text-white text-sm">₹${item.price}</p>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-800 rounded-lg p-1">
                                <button onclick="updateQty('${item.id}', -1)"
                                    class="size-6 flex items-center justify-center bg-white dark:bg-card-dark rounded shadow-sm hover:text-primary transition-colors text-xs">-</button>
                                <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                                <button onclick="updateQty('${item.id}', 1)"
                                    class="size-6 flex items-center justify-center bg-white dark:bg-card-dark rounded shadow-sm hover:text-primary transition-colors text-xs">+</button>
                            </div>
                            <button onclick="removeFromCart('${item.id}')"
                                class="text-red-400 hover:text-red-500 text-xs font-medium">Remove</button>
                        </div>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            updateTotals(subtotal);
        }

        function updateTotals(subtotal) {
            const tax = subtotal * 0.05;
            const total = subtotal + tax;

            document.getElementById('subtotalLabel').innerText = `Subtotal (${cart.reduce((a, c) => a + c.qty, 0)} items)`;
            document.getElementById('subtotalDisplay').innerText = `₹${subtotal.toFixed(2)}`;
            document.getElementById('taxDisplay').innerText = `₹${tax.toFixed(2)}`;
            document.getElementById('totalDisplay').innerText = `₹${total.toFixed(2)}`;
        }

        async function saveSale() {
            if (cart.length === 0) {
                alert('Cart is empty!');
                return;
            }

            const btn = document.querySelector('button[onclick="saveSale()"]');
            const originalText = btn.innerText;
            btn.innerText = 'Processing...';
            btn.disabled = true;

            try {
                const totalAmount = parseFloat(document.getElementById('totalDisplay').innerText.replace('₹', ''));

                const formData = new URLSearchParams();
                formData.append('action', 'saveSale');
                formData.append('date', new Date().toISOString().split('T')[0]);
                formData.append('data', JSON.stringify(cart));
                formData.append('totalAmount', totalAmount);
                formData.append('paymentMethod', 'Cash'); // Defaulting to Cash

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.result === 'success') {
                    alert('Sale completed successfully!');
                    cart = [];
                    renderCart();
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Sale error:', error);
                alert('Error completing sale: ' + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Initialize
        document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        fetchProducts();
        fetchSales();

        // --- NEW FUNCTIONS ---

        function handleProductSearch() {
            const query = document.getElementById('productSearchInput').value.toLowerCase();
            const filtered = products.filter(p => {
                const name = (p['Name'] || '').toLowerCase();
                const id = (p['Item ID'] || '').toLowerCase();
                return name.includes(query) || id.includes(query);
            });
            renderProducts(filtered);
        }

        let isGridView = false;
        function toggleViewAllProducts() {
            isGridView = !isGridView;
            const container = document.getElementById('productsContainer');
            const btn = document.getElementById('viewAllProductsBtn');

            if (isGridView) {
                container.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-4 px-2 max-h-[500px] overflow-y-auto";
                btn.innerText = "View Less";
            } else {
                container.className = "flex gap-4 overflow-x-auto scrollbar-hide pb-4 -mx-2 px-2";
                btn.innerText = "View All";
            }
        }

        let salesData = [];
        async function fetchSales() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getSales`);
                const data = await response.json();
                if (Array.isArray(data)) {
                    salesData = data.reverse(); // Newest first
                    renderRecentSales();
                }
            } catch (error) {
                console.error("Error fetching sales:", error);
            }
        }

        function renderRecentSales() {
            const tbody = document.getElementById('recentTransactionsBody');
            tbody.innerHTML = '';

            const recent = salesData.slice(0, 5);
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-text-muted">No sales found</td></tr>';
                return;
            }

            recent.forEach(sale => {
                // Headers from backend: Sale ID, Date, Item Summary, Total Amount, Details
                const date = safeParseDate(sale['Date'] || sale['date']);
                const items = sale['Item Summary'] || sale['itemSummary'] || 'Unknown items';
                const total = sale['Total Amount'] || sale['totalAmount'] || 0;
                const id = sale['Sale ID'] || sale['saleId'] || '';

                const html = `
                <tr class="hover:bg-background-warm/50 dark:hover:bg-gray-800/30 transition-colors">
                    <td class="p-4 whitespace-nowrap">
                        <p class="text-sm font-medium text-text-main dark:text-white">${date}</p>
                    </td>
                    <td class="p-4 text-sm text-text-main dark:text-gray-300 max-w-xs truncate" title="${items}">
                        ${items}
                    </td>
                    <td class="p-4 text-sm text-text-muted font-mono">
                        ${id}
                    </td>
                    <td class="p-4 text-right text-sm font-bold text-green-600 dark:text-green-400">
                        + ₹${total}
                    </td>
                    <td class="p-4 text-center">
                        <button class="text-text-muted hover:text-primary transition-colors p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span class="material-symbols-outlined text-lg">receipt_long</span>
                        </button>
                    </td>
                </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', html);
            });
        }

        function openSalesHistoryModal() {
            document.getElementById('salesHistoryModal').classList.remove('hidden');
            renderSalesHistory();
        }

        function renderSalesHistory() {
            const tbody = document.getElementById('fullSalesGraphBody');
            tbody.innerHTML = '';

            salesData.forEach(sale => {
                const date = safeParseDate(sale['Date']);
                const items = sale['Item Summary'] || '';
                const total = sale['Total Amount'] || 0;
                const id = sale['Sale ID'] || '';

                const html = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors border-b border-gray-100 dark:border-gray-800 last:border-0">
                    <td class="p-4 text-text-main dark:text-white whitespace-nowrap">${date}</td>
                     <td class="p-4 text-text-muted font-mono text-xs">${id}</td>
                    <td class="p-4 text-text-main dark:text-gray-300">${items}</td>
                    <td class="p-4 text-right font-bold text-green-600">₹${total}</td>
                </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', html);
            });
        }

        function safeParseDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

    </script>
</body>

</html>